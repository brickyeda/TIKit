<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>转砖 砖 爪 - TIKit</title>
  <link rel="icon" type="image/png" href="https://brickyeda.github.io/TIKit/logo.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    .logo {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }

    .success-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    h1 {
      color: #22c55e;
      margin-bottom: 15px;
      font-size: 1.8rem;
    }

    .message {
      color: #4b5563;
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 25px;
    }

    .plan-info {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border: 2px solid #86efac;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .plan-info h3 {
      color: #166534;
      margin-bottom: 10px;
    }

    .plan-info p {
      color: #15803d;
      font-size: 0.95rem;
    }

    .btn {
      display: inline-block;
      padding: 15px 40px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .loading {
      color: #667eea;
    }

    .error {
      color: #dc2626;
      background: #fef2f2;
      border: 1px solid #fecaca;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .container {
        padding: 30px 20px;
      }

      h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://brickyeda.github.io/TIKit/logo.png" alt="TIKit Logo" class="logo">
    
    <div id="loading">
      <div class="spinner"></div>
      <h1 class="loading">注 转 转砖...</h1>
      <p class="message"> 转 专注</p>
    </div>

    <div id="success" style="display: none;">
      <div class="success-icon"></div>
      <h1>转砖 砖 爪!</h1>
      <p class="message">专   Pro! 注砖 砖  砖  驻爪'专 转拽.</p>
      
      <div class="plan-info">
        <h3 id="planTitle"> Pro</h3>
        <p id="planDetails"></p>
      </div>

      <a href="index.html" class="btn">砖 驻拽爪</a>
    </div>

    <div id="error" style="display: none;">
      <div class="success-icon">锔</div>
      <h1 style="color: #dc2626;">砖 砖转砖</h1>
      <div class="error" id="errorMessage"></div>
      <a href="index.html" class="btn">专 驻拽爪</a>
    </div>
  </div>

  <script>
    // 专转 Supabase
    const SUPABASE_URL = 'https://ditiequwboxbiqrzvfhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdGllcXV3Ym94Ymlxcnp2ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NDQ4NDUsImV4cCI6MjA4MTQyMDg0NX0.HM6FhOilvJJnLpooweEQjuXmdUBEZ9jc-59jIS_be_k';
    
    let supabaseClient = null;

    // 拽转 驻专专 -URL (case-insensitive)
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      
      // 驻拽爪 拽转 驻专专  转转 转转 转/拽转
      function getParam(name) {
        // 住 转 砖 拽专
        let value = params.get(name);
        if (value) return value;
        
        // 住 注 转转 转
        value = params.get(name.toUpperCase());
        if (value) return value;
        
        // 住 注 转转 拽转
        value = params.get(name.toLowerCase());
        if (value) return value;
        
        // 驻砖  驻专专 (case-insensitive)
        for (const [key, val] of params.entries()) {
          if (key.toLowerCase() === name.toLowerCase()) {
            return val;
          }
        }
        
        return null;
      }
      
      return {
        customerId: getParam('OG-CustomerID'),
        paymentId: getParam('OG-PaymentID'),
        paymentType: getParam('OG-PaymentType'),
        documentNumber: getParam('OG-DocumentNumber'),
        externalId: getParam('OG-ExternalIdentifier') //  -user_id 砖
      };
    }

    // 爪转 爪
    function showSuccess(planType) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('success').style.display = 'block';
      
      if (planType === 'yearly') {
        document.getElementById('planTitle').textContent = ' 砖转 Pro';
        document.getElementById('planDetails').textContent = ' 砖 驻注 砖 拽专. 转 注 !';
      } else {
        document.getElementById('planTitle').textContent = ' 砖 Pro';
        document.getElementById('planDetails').textContent = ' 砖 驻注 转砖 转  砖.';
      }
    }

    // 爪转 砖
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }

    // 注 转砖
    async function processPayment() {
      const params = getUrlParams();
      console.log('驻专专 住:', params);

      // 拽 砖拽 驻专专
      if (!params.paymentId) {
        showError(' 转拽 驻专 转砖.  驻 转.');
        return;
      }

      // 转 -Supabase
      let attempts = 0;
      while (typeof window.supabase === 'undefined' && attempts < 20) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (typeof window.supabase === 'undefined') {
        showError('砖 注转 注专转.  专注 转 祝.');
        return;
      }

      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // 拽转 砖转砖 专
      const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
      
      if (userError || !user) {
        console.log('砖转砖  专, 砖转砖 -externalId:', params.externalId);
      }

      const userId = user?.id || params.externalId;
      const userEmail = user?.email || null; // 砖专转 

      if (!userId) {
        showError(' 转 转 转 砖转砖.  转专 住 砖.');
        return;
      }

      // 驻注 住  -externalId
      // 驻专: userId_planType  专拽 userId
      let actualUserId = userId;
      let planType = 'monthly'; // 专专转 
      let price = 10.90;
      let expiresAt = new Date();
      
      if (userId.includes('_')) {
        const parts = userId.split('_');
        actualUserId = parts[0];
        const planFromUrl = parts[1];
        
        if (planFromUrl === 'yearly') {
          planType = 'yearly';
          price = 119.90;
          expiresAt.setFullYear(expiresAt.getFullYear() + 1);
        } else {
          planType = 'monthly';
          price = 10.90;
          expiresAt.setMonth(expiresAt.getMonth() + 1);
        }
      } else {
        //  注 注 住  - 专专转  砖
        expiresAt.setMonth(expiresAt.getMonth() + 1);
      }

      console.log(' 住 :', planType, '| 专:', price, '| 砖转砖:', actualUserId);

      try {
        // 拽  专 砖  驻注 ( 住)
        const { data: existingSub } = await supabaseClient
          .from('subscriptions')
          .select('*')
          .eq('user_id', actualUserId)
          .eq('status', 'active')
          .single();

        if (existingSub) {
          // 注  拽 - 砖专 住 驻专
          const updateData = {
            plan_type: planType,
            price: price,
            sumit_customer_id: params.customerId,
            sumit_payment_id: params.paymentId,
            started_at: new Date().toISOString(),
            expires_at: expiresAt.toISOString(),
            updated_at: new Date().toISOString()
          };
          
          // 住祝   砖
          if (userEmail) {
            updateData.user_email = userEmail;
          }

          const { error: updateError } = await supabaseClient
            .from('subscriptions')
            .update(updateData)
            .eq('id', existingSub.id);

          if (updateError) {
            console.error('砖 注 :', updateError);
          }

          // 注  转 profiles
          await supabaseClient
            .from('profiles')
            .update({
              plan: 'pro',
              subscription_type: planType,
              plan_until: expiresAt.toISOString(),
              updated_at: new Date().toISOString()
            })
            .eq('id', actualUserId);

          showSuccess(planType);
        } else {
          // 爪专转  砖
          const insertData = {
            user_id: actualUserId,
            plan_type: planType,
            status: 'active',
            sumit_customer_id: params.customerId,
            sumit_payment_id: params.paymentId,
            price: price,
            started_at: new Date().toISOString(),
            expires_at: expiresAt.toISOString()
          };
          
          // 住祝   砖
          if (userEmail) {
            insertData.user_email = userEmail;
          }

          const { data: newSub, error: insertError } = await supabaseClient
            .from('subscriptions')
            .insert(insertData)
            .select()
            .single();

          if (insertError) {
            console.error('砖 爪专转 :', insertError);
            showError('砖 驻注转 . 转砖 转拽,  驻 转.');
            return;
          }

          // 注  转 profiles
          await supabaseClient
            .from('profiles')
            .update({
              plan: 'pro',
              subscription_type: planType,
              plan_until: expiresAt.toISOString(),
              updated_at: new Date().toISOString()
            })
            .eq('id', actualUserId);

          showSuccess(planType);
        }

      } catch (err) {
        console.error('砖:', err);
        showError('砖 注 转砖.  驻 转.');
      }
    }

    // 驻注
    window.addEventListener('load', processPayment);
  </script>
</body>
</html>
