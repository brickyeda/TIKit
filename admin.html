<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×”×•×œ ××¢×¨×›×ª - TIKit</title>
  <link rel="icon" type="image/png" href="https://brickyeda.github.io/TIKit/logo.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --success-color: #22c55e;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      color: var(--text-primary);
      min-height: 100vh;
      direction: rtl;
    }

    /* Header */
    .admin-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .admin-header h1 {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
    }

    .admin-header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-primary {
      background: white;
      color: var(--primary-color);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    /* Main Content */
    .admin-content {
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      text-align: center;
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 5px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 8px 8px 0 0;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .tab:hover {
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
    }

    /* Table */
    .table-container {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      overflow: hidden;
    }

    .table-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-header h2 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-box {
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 0.95rem;
      width: 250px;
      transition: border-color 0.2s;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 15px 20px;
      text-align: right;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background: #f9fafb;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    tr:hover {
      background: #f9fafb;
    }

    /* Badges */
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge-pro {
      background: #dcfce7;
      color: #166534;
    }

    .badge-trial {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-free {
      background: #f3f4f6;
      color: #6b7280;
    }

    .badge-active {
      background: #dcfce7;
      color: #166534;
    }

    .badge-expired {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-cancelled {
      background: #f3f4f6;
      color: #6b7280;
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 8px;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      transform: scale(0.9);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal h3 {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 50px;
      color: var(--text-secondary);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Access Denied */
    .access-denied {
      text-align: center;
      padding: 100px 20px;
    }

    .access-denied-icon {
      font-size: 5rem;
      margin-bottom: 20px;
    }

    .access-denied h2 {
      color: var(--danger-color);
      margin-bottom: 15px;
    }

    .access-denied p {
      color: var(--text-secondary);
      margin-bottom: 25px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .table-header {
        flex-direction: column;
        gap: 15px;
      }

      .search-box {
        width: 100%;
      }

      table {
        font-size: 0.85rem;
      }

      th, td {
        padding: 10px;
      }

      .actions {
        flex-direction: column;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 50px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingState" class="loading" style="padding-top: 100px;">
    <div class="spinner"></div>
    <p>×˜×•×¢×Ÿ...</p>
  </div>

  <!-- Access Denied -->
  <div id="accessDenied" class="access-denied" style="display: none;">
    <div class="access-denied-icon">ğŸš«</div>
    <h2>×’×™×©×” × ×“×—×ª×”</h2>
    <p>××™×Ÿ ×œ×š ×”×¨×©××” ×œ×’×©×ª ×œ×“×£ ×–×”.</p>
    <button class="btn btn-primary" onclick="window.location.href='index.html'">×—×–×•×¨ ×œ××¤×œ×™×§×¦×™×”</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display: none;">
    <header class="admin-header">
      <h1>
        <span>âš™ï¸</span>
        × ×™×”×•×œ ××¢×¨×›×ª - TIKit
      </h1>
      <div class="admin-header-actions">
        <button class="btn btn-secondary" onclick="loadData()">ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×</button>
        <button class="btn btn-primary" onclick="window.location.href='index.html'">â† ×—×–×•×¨ ×œ××¤×œ×™×§×¦×™×”</button>
      </div>
    </header>

    <main class="admin-content">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">×¡×”"×› ××©×ª××©×™×</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â­</div>
          <div class="stat-value" id="proUsers">0</div>
          <div class="stat-label">××©×ª××©×™ Pro</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ</div>
          <div class="stat-value" id="trialUsers">0</div>
          <div class="stat-label">×‘×ª×§×•×¤×ª × ×™×¡×™×•×Ÿ</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ†“</div>
          <div class="stat-value" id="freeUsers">0</div>
          <div class="stat-label">××©×ª××©×™ ×—×™× ×</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showTab('users')">ğŸ‘¥ ××©×ª××©×™×</button>
        <button class="tab" onclick="showTab('subscriptions')">ğŸ’³ ×× ×•×™×™×</button>
      </div>

      <!-- Users Tab -->
      <div id="usersTab" class="table-container">
        <div class="table-header">
          <h2>ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×</h2>
          <input type="text" class="search-box" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ××™×™×œ ××• ×©×..." oninput="filterUsers(this.value)">
        </div>
        <table>
          <thead>
            <tr>
              <th>××©×ª××©</th>
              <th>××™×™×œ</th>
              <th>×¡×˜×˜×•×¡</th>
              <th>×ª××¨×™×š ×”×¨×©××”</th>
              <th>×ª×Ÿ ×× ×•×™</th>
              <th>×‘×˜×œ ×× ×•×™</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="6" class="loading">
                <div class="spinner"></div>
                <p>×˜×•×¢×Ÿ ××©×ª××©×™×...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Subscriptions Tab -->
      <div id="subscriptionsTab" class="table-container" style="display: none;">
        <div class="table-header">
          <h2>ğŸ’³ × ×™×”×•×œ ×× ×•×™×™×</h2>
          <button class="btn btn-success" onclick="openAddSubscriptionModal()">â• ×”×•×¡×£ ×× ×•×™</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>××©×ª××©</th>
              <th>×¡×•×’ ×× ×•×™</th>
              <th>×¡×˜×˜×•×¡</th>
              <th>×ª×•×§×£ ×¢×“</th>
              <th>×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody id="subscriptionsTableBody">
            <tr>
              <td colspan="5" class="loading">
                <div class="spinner"></div>
                <p>×˜×•×¢×Ÿ ×× ×•×™×™×...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Add/Edit Subscription Modal -->
  <div class="modal-overlay" id="subscriptionModal">
    <div class="modal">
      <h3>â• <span id="modalTitle">×”×•×¡×£ ×× ×•×™</span></h3>
      <div class="form-group">
        <label>××™×™×œ ×”××©×ª××©</label>
        <input type="email" id="subUserEmail" placeholder="user@example.com">
      </div>
      <div class="form-group">
        <label>×¡×•×’ ×× ×•×™</label>
        <select id="subPlanType">
          <option value="monthly">×—×•×“×©×™ (â‚ª10.90)</option>
          <option value="yearly">×©× ×ª×™ (â‚ª119.90)</option>
          <option value="trial">×ª×§×•×¤×ª × ×™×¡×™×•×Ÿ (×—×™× ×)</option>
        </select>
      </div>
      <div class="form-group">
        <label>××©×š (×‘×™××™×)</label>
        <input type="number" id="subDuration" value="30" min="1">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('subscriptionModal')">×‘×™×˜×•×œ</button>
        <button class="btn btn-success" onclick="saveSubscription()">ğŸ’¾ ×©××•×¨</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal">
      <h3>âš ï¸ <span id="confirmTitle">××™×©×•×¨</span></h3>
      <p id="confirmMessage">×”×× ××ª×” ×‘×˜×•×—?</p>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('confirmModal')">×‘×™×˜×•×œ</button>
        <button class="btn btn-danger" id="confirmBtn" onclick="confirmAction()">××™×©×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Cancel Subscription Modal with Code -->
  <div class="modal-overlay" id="cancelCodeModal">
    <div class="modal">
      <h3>ğŸš« ×‘×™×˜×•×œ ×× ×•×™</h3>
      <p id="cancelUserName" style="margin-bottom: 15px; font-weight: 600;"></p>
      <p style="margin-bottom: 10px;">×œ×”××©×š, ×”×§×œ×“ ××ª ×§×•×“ ×”××™×©×•×¨:</p>
      <div style="background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
        <span id="cancelCode" style="font-size: 1.5rem; font-weight: 700; letter-spacing: 5px; color: #991b1b;"></span>
      </div>
      <div class="form-group">
        <input type="text" id="cancelCodeInput" placeholder="×”×§×œ×“ ××ª ×”×§×•×“" style="text-align: center; font-size: 1.2rem; letter-spacing: 3px;">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('cancelCodeModal')">×‘×™×˜×•×œ</button>
        <button class="btn btn-danger" onclick="confirmCancelWithCode()">ğŸš« ×‘×˜×œ ×× ×•×™</button>
      </div>
    </div>
  </div>

  <script>
    // ×”×’×“×¨×•×ª
    const SUPABASE_URL = 'https://ditiequwboxbiqrzvfhr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdGllcXV3Ym94Ymlxcnp2ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NDQ4NDUsImV4cCI6MjA4MTQyMDg0NX0.HM6FhOilvJJnLpooweEQjuXmdUBEZ9jc-59jIS_be_k';
    const ADMIN_EMAIL = 'brickyeda@gmail.com';

    let supabaseClient = null;
    let currentUser = null;
    let allUsers = [];
    let allSubscriptions = [];
    let pendingAction = null;
    let pendingCancelUserId = null;
    let currentCancelCode = null;

    // ××ª×—×•×œ
    window.addEventListener('load', async () => {
      // ×”××ª× ×” ×œ-Supabase
      let attempts = 0;
      while (typeof window.supabase === 'undefined' && attempts < 20) {
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }

      if (typeof window.supabase === 'undefined') {
        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¢×¨×›×ª');
        return;
      }

      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ×‘×“×™×§×ª ××©×ª××©
      const { data: { user } } = await supabaseClient.auth.getUser();
      currentUser = user;

      document.getElementById('loadingState').style.display = 'none';

      if (!user || user.email !== ADMIN_EMAIL) {
        document.getElementById('accessDenied').style.display = 'block';
        return;
      }

      document.getElementById('adminPanel').style.display = 'block';
      loadData();
    });

    // ×˜×¢×™× ×ª × ×ª×•× ×™×
    async function loadData() {
      await Promise.all([
        loadUsers(),
        loadSubscriptions()
      ]);
      updateStats();
    }

    // ×˜×¢×™× ×ª ××©×ª××©×™×
    async function loadUsers() {
      try {
        // ×˜×¢×™× ×ª ××©×ª××©×™× ×-profiles
        const { data: profiles, error } = await supabaseClient
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        // ×’× ×˜×¢×™× ×ª ×× ×•×™×™× ××˜×‘×œ×ª subscriptions (×›×œ ×”×¡×˜×˜×•×¡×™×)
        const { data: subs } = await supabaseClient
          .from('subscriptions')
          .select('*');

        console.log('ğŸ“Š Profiles:', profiles);
        console.log('ğŸ“Š Subscriptions:', subs);

        // ××™×¤×•×™ ×× ×•×™×™× ×œ×¤×™ user_id - ×¨×§ ×¤×¢×™×œ×™×
        const subsMap = {};
        if (subs) {
          subs.forEach(sub => {
            // ×‘×•×“×§ ×× ×”×× ×•×™ ×¤×¢×™×œ ×•×œ× ×¤×’ ×ª×•×§×£
            const isActive = sub.status === 'active' && 
                            (!sub.expires_at || new Date(sub.expires_at) > new Date());
            if (isActive) {
              subsMap[sub.user_id] = sub;
            }
          });
        }

        console.log('ğŸ“Š Active Subs Map:', subsMap);

        allUsers = (profiles || []).map(p => {
          // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ - ×§×•×“× ×-subscriptions, ××—×› ×-profiles
          let subscription = subsMap[p.id] || null;
          
          // ×× ××™×Ÿ ×‘-subscriptions ××‘×œ ×™×© plan=pro ×‘-profiles
          if (!subscription && p.plan === 'pro' && p.plan_until && new Date(p.plan_until) > new Date()) {
            subscription = {
              plan_type: p.subscription_type || 'monthly',
              status: 'active',
              expires_at: p.plan_until,
              source: 'profiles' // ×œ×¡×™××•×Ÿ ×©×–×” ×-profiles
            };
          }
          
          return {
            ...p,
            subscription: subscription
          };
        });

        console.log('ğŸ“Š All Users with subs:', allUsers);

        renderUsers(allUsers);
      } catch (e) {
        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×:', e);
        document.getElementById('usersTableBody').innerHTML = `
          <tr><td colspan="5" class="empty-state">
            <div class="empty-state-icon">âŒ</div>
            <p>×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×</p>
          </td></tr>
        `;
      }
    }

    // ×”×¦×’×ª ××©×ª××©×™×
    function renderUsers(users) {
      const tbody = document.getElementById('usersTableBody');

      if (!users || users.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6" class="empty-state">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <p>××™×Ÿ ××©×ª××©×™× ×œ×”×¦×’×”</p>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = users.map(user => {
        const sub = user.subscription;
        let statusBadge = '<span class="badge badge-free">×—×™× ×</span>';
        let cancelBtn = '<span style="color: #ccc;">â€”</span>';

        if (sub) {
          if (sub.plan_type === 'trial') {
            statusBadge = '<span class="badge badge-trial">× ×™×¡×™×•×Ÿ</span>';
          } else {
            statusBadge = '<span class="badge badge-pro">Pro</span>';
          }
          cancelBtn = `<button class="btn btn-sm btn-danger" onclick="cancelUserSubscription('${user.id}', '${user.display_name || user.email?.split('@')[0] || '××©×ª××©'}')">ğŸš« ×‘×˜×œ</button>`;
        }

        const displayName = user.display_name || user.email?.split('@')[0] || '×œ×œ× ×©×';
        const email = user.email || user.id;
        const createdAt = user.created_at ? new Date(user.created_at).toLocaleDateString('he-IL') : '---';

        return `
          <tr>
            <td><strong>${displayName}</strong></td>
            <td>${email}</td>
            <td>${statusBadge}</td>
            <td>${createdAt}</td>
            <td>
              <button class="btn btn-sm btn-success" onclick="giveSubscription('${user.id}', '${email}')">ğŸ ×ª×Ÿ ×× ×•×™</button>
            </td>
            <td>
              ${cancelBtn}
            </td>
          </tr>
        `;
      }).join('');
    }

    // ×¡×™× ×•×Ÿ ××©×ª××©×™×
    function filterUsers(query) {
      const filtered = allUsers.filter(u => {
        const searchStr = `${u.display_name || ''} ${u.email || ''}`.toLowerCase();
        return searchStr.includes(query.toLowerCase());
      });
      renderUsers(filtered);
    }

    // ×˜×¢×™× ×ª ×× ×•×™×™×
    async function loadSubscriptions() {
      try {
        const { data, error } = await supabaseClient
          .from('subscriptions')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allSubscriptions = data || [];
        renderSubscriptions(allSubscriptions);
      } catch (e) {
        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×× ×•×™×™×:', e);
      }
    }

    // ×”×¦×’×ª ×× ×•×™×™×
    function renderSubscriptions(subs) {
      const tbody = document.getElementById('subscriptionsTableBody');

      if (!subs || subs.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="5" class="empty-state">
            <div class="empty-state-icon">ğŸ’³</div>
            <p>××™×Ÿ ×× ×•×™×™× ×œ×”×¦×’×”</p>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = subs.map(sub => {
        // ××¦×™××ª ×”××©×ª××©
        const user = allUsers.find(u => u.id === sub.user_id);
        const displayName = user?.display_name || user?.email?.split('@')[0] || sub.user_id.substring(0, 8);

        // ×¡×•×’ ×× ×•×™
        let planLabel = '×—×•×“×©×™';
        if (sub.plan_type === 'yearly') planLabel = '×©× ×ª×™';
        if (sub.plan_type === 'trial') planLabel = '× ×™×¡×™×•×Ÿ';

        // ×¡×˜×˜×•×¡
        let statusBadge = '<span class="badge badge-active">×¤×¢×™×œ</span>';
        if (sub.status === 'cancelled') {
          statusBadge = '<span class="badge badge-cancelled">×‘×•×˜×œ</span>';
        } else if (sub.status === 'expired' || (sub.expires_at && new Date(sub.expires_at) < new Date())) {
          statusBadge = '<span class="badge badge-expired">×¤×’ ×ª×•×§×£</span>';
        }

        const expiresAt = sub.expires_at ? new Date(sub.expires_at).toLocaleDateString('he-IL') : '---';

        return `
          <tr>
            <td><strong>${displayName}</strong></td>
            <td>${planLabel}</td>
            <td>${statusBadge}</td>
            <td>${expiresAt}</td>
            <td>
              <div class="actions">
                <button class="btn btn-sm btn-warning" onclick="extendSubscription('${sub.id}')">ğŸ“… ×”××¨×š</button>
                <button class="btn btn-sm btn-danger" onclick="cancelSubscription('${sub.id}')">ğŸš« ×‘×˜×œ</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
    function updateStats() {
      const total = allUsers.length;
      let pro = 0, trial = 0, free = 0;

      allUsers.forEach(u => {
        if (u.subscription) {
          if (u.subscription.plan_type === 'trial') {
            trial++;
          } else {
            pro++;
          }
        } else {
          free++;
        }
      });

      document.getElementById('totalUsers').textContent = total;
      document.getElementById('proUsers').textContent = pro;
      document.getElementById('trialUsers').textContent = trial;
      document.getElementById('freeUsers').textContent = free;
    }

    // ××¢×‘×¨ ×‘×™×Ÿ ×˜××‘×™×
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.table-container').forEach(t => t.style.display = 'none');

      if (tab === 'users') {
        document.querySelector('.tab:nth-child(1)').classList.add('active');
        document.getElementById('usersTab').style.display = 'block';
      } else {
        document.querySelector('.tab:nth-child(2)').classList.add('active');
        document.getElementById('subscriptionsTab').style.display = 'block';
      }
    }

    // ××ª×Ÿ ×× ×•×™ ×œ××©×ª××©
    function giveSubscription(userId, email) {
      document.getElementById('modalTitle').textContent = '×”×•×¡×£ ×× ×•×™';
      document.getElementById('subUserEmail').value = email;
      document.getElementById('subUserEmail').dataset.userId = userId;
      document.getElementById('subPlanType').value = 'monthly';
      document.getElementById('subDuration').value = 30;
      openModal('subscriptionModal');
    }

    // ×¤×ª×™×—×ª ××•×“××œ ×”×•×¡×¤×ª ×× ×•×™
    function openAddSubscriptionModal() {
      document.getElementById('modalTitle').textContent = '×”×•×¡×£ ×× ×•×™';
      document.getElementById('subUserEmail').value = '';
      document.getElementById('subUserEmail').dataset.userId = '';
      document.getElementById('subPlanType').value = 'monthly';
      document.getElementById('subDuration').value = 30;
      openModal('subscriptionModal');
    }

    // ×©××™×¨×ª ×× ×•×™
    async function saveSubscription() {
      const email = document.getElementById('subUserEmail').value.trim();
      let userId = document.getElementById('subUserEmail').dataset.userId;
      const planType = document.getElementById('subPlanType').value;
      const duration = parseInt(document.getElementById('subDuration').value) || 30;

      if (!email && !userId) {
        alert('×™×© ×œ×”×–×™×Ÿ ××™×™×œ');
        return;
      }

      // ×× ××™×Ÿ userId, ××—×¤×© ×œ×¤×™ ××™×™×œ
      if (!userId) {
        const user = allUsers.find(u => u.email === email);
        if (!user) {
          alert('××©×ª××© ×œ× × ××¦×');
          return;
        }
        userId = user.id;
      }

      const expiresAt = new Date();
      expiresAt.setDate(expiresAt.getDate() + duration);

      try {
        // ×‘×“×™×§×” ×× ×™×© ×× ×•×™ ×§×™×™×
        const { data: existing } = await supabaseClient
          .from('subscriptions')
          .select('id')
          .eq('user_id', userId)
          .eq('status', 'active')
          .single();

        if (existing) {
          // ×¢×“×›×•×Ÿ ×× ×•×™ ×§×™×™×
          const { error } = await supabaseClient
            .from('subscriptions')
            .update({
              plan_type: planType,
              expires_at: expiresAt.toISOString(),
              updated_at: new Date().toISOString()
            })
            .eq('id', existing.id);

          if (error) throw error;
        } else {
          // ×™×¦×™×¨×ª ×× ×•×™ ×—×“×©
          const { error } = await supabaseClient
            .from('subscriptions')
            .insert({
              user_id: userId,
              plan_type: planType,
              status: 'active',
              price: planType === 'trial' ? 0 : (planType === 'yearly' ? 119.90 : 10.90),
              started_at: new Date().toISOString(),
              expires_at: expiresAt.toISOString()
            });

          if (error) throw error;
        }

        closeModal('subscriptionModal');
        alert('âœ… ×”×× ×•×™ × ×©××¨ ×‘×”×¦×œ×—×”!');
        loadData();
      } catch (e) {
        console.error('×©×’×™××” ×‘×©××™×¨×ª ×× ×•×™:', e);
        alert('×©×’×™××” ×‘×©××™×¨×ª ×”×× ×•×™');
      }
    }

    // ×”××¨×›×ª ×× ×•×™
    function extendSubscription(subId) {
      pendingAction = async () => {
        try {
          const sub = allSubscriptions.find(s => s.id === subId);
          if (!sub) return;

          const currentExpiry = new Date(sub.expires_at);
          const newExpiry = new Date(currentExpiry);
          newExpiry.setDate(newExpiry.getDate() + 30);

          const { error } = await supabaseClient
            .from('subscriptions')
            .update({
              expires_at: newExpiry.toISOString(),
              updated_at: new Date().toISOString()
            })
            .eq('id', subId);

          if (error) throw error;

          alert('âœ… ×”×× ×•×™ ×”×•××¨×š ×‘-30 ×™×•×!');
          loadData();
        } catch (e) {
          console.error('×©×’×™××”:', e);
          alert('×©×’×™××” ×‘×”××¨×›×ª ×”×× ×•×™');
        }
      };

      document.getElementById('confirmTitle').textContent = '×”××¨×›×ª ×× ×•×™';
      document.getElementById('confirmMessage').textContent = '×œ×”××¨×™×š ××ª ×”×× ×•×™ ×‘-30 ×™×•×?';
      document.getElementById('confirmBtn').className = 'btn btn-success';
      document.getElementById('confirmBtn').textContent = '×”××¨×š';
      openModal('confirmModal');
    }

    // ×‘×™×˜×•×œ ×× ×•×™
    function cancelSubscription(subId) {
      pendingAction = async () => {
        try {
          const { error } = await supabaseClient
            .from('subscriptions')
            .update({
              status: 'cancelled',
              updated_at: new Date().toISOString()
            })
            .eq('id', subId);

          if (error) throw error;

          alert('âœ… ×”×× ×•×™ ×‘×•×˜×œ!');
          loadData();
        } catch (e) {
          console.error('×©×’×™××”:', e);
          alert('×©×’×™××” ×‘×‘×™×˜×•×œ ×”×× ×•×™');
        }
      };

      document.getElementById('confirmTitle').textContent = '×‘×™×˜×•×œ ×× ×•×™';
      document.getElementById('confirmMessage').textContent = '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×”×× ×•×™?';
      document.getElementById('confirmBtn').className = 'btn btn-danger';
      document.getElementById('confirmBtn').textContent = '×‘×˜×œ ×× ×•×™';
      openModal('confirmModal');
    }

    // ×‘×™×˜×•×œ ×× ×•×™ ×œ××©×ª××© ×¡×¤×¦×™×¤×™ ×¢× ×§×•×“ ××™×©×•×¨
    function cancelUserSubscription(userId, userName) {
      // ×™×¦×™×¨×ª ×§×•×“ ××§×¨××™
      currentCancelCode = Math.random().toString(36).substring(2, 8).toUpperCase();
      pendingCancelUserId = userId;
      
      document.getElementById('cancelUserName').textContent = `××©×ª××©: ${userName}`;
      document.getElementById('cancelCode').textContent = currentCancelCode;
      document.getElementById('cancelCodeInput').value = '';
      
      openModal('cancelCodeModal');
    }

    // ××™×©×•×¨ ×‘×™×˜×•×œ ×¢× ×§×•×“
    async function confirmCancelWithCode() {
      const inputCode = document.getElementById('cancelCodeInput').value.trim().toUpperCase();
      
      if (inputCode !== currentCancelCode) {
        alert('âŒ ×§×•×“ ×©×’×•×™! × ×¡×” ×©×•×‘.');
        document.getElementById('cancelCodeInput').value = '';
        return;
      }
      
      try {
        const user = allUsers.find(u => u.id === pendingCancelUserId);
        if (!user || !user.subscription) {
          alert('×œ× × ××¦× ×× ×•×™ ×œ×‘×™×˜×•×œ');
          closeModal('cancelCodeModal');
          return;
        }

        // ××—×™×§×ª ×”×× ×•×™ ××˜×‘×œ×ª subscriptions
        if (user.subscription.id) {
          const { error: subError } = await supabaseClient
            .from('subscriptions')
            .delete()
            .eq('user_id', pendingCancelUserId);

          if (subError) throw subError;
        }

        // ××™×¤×•×¡ ×‘-profiles ×× ×™×© ×©× × ×ª×•× ×™×
        const { error: profileError } = await supabaseClient
          .from('profiles')
          .update({
            plan: 'free',
            plan_until: null,
            subscription_type: null,
            updated_at: new Date().toISOString()
          })
          .eq('id', pendingCancelUserId);

        if (profileError) {
          console.log('×œ× ×¢×•×“×›×Ÿ profiles:', profileError);
        }

        closeModal('cancelCodeModal');
        alert('âœ… ×”×× ×•×™ ×‘×•×˜×œ ×•×”××©×ª××© ×—×–×¨ ×œ×’×¨×¡×” ×”×—×™× ××™×ª!');
        loadData();
        
      } catch (e) {
        console.error('×©×’×™××” ×‘×‘×™×˜×•×œ:', e);
        alert('×©×’×™××” ×‘×‘×™×˜×•×œ ×”×× ×•×™');
      }
    }

    // ××™×©×•×¨ ×¤×¢×•×œ×”
    function confirmAction() {
      closeModal('confirmModal');
      if (pendingAction) {
        pendingAction();
        pendingAction = null;
      }
    }

    // ×¤×ª×™×—×ª ××•×“××œ
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    // ×¡×’×™×¨×ª ××•×“××œ
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ××—×•×¥ ×œ××•×“××œ
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>
